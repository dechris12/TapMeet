<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TapMeet 💜</title>

<!-- PWA manifest -->
<link rel="manifest" href="manifest.json">

<style>
  :root{
    --bg:#0a001a;
    --card:#1a002e;
    --accent:#6a0dad;
    --accent-weak:#8b3bdc;
    --muted:#bdb7d9;
    --white:#ffffff;
  }

  /* Light mode support */
  body.light {
    --bg:#f7f0ff; --card:#fff; --accent:#6a0dad; --accent-weak:#8b3bdc; --muted:#5c2b8e; --white:#111;
  }

  html,body{height:100%; margin:0; font-family:Inter, system-ui, -apple-system, Arial, sans-serif; background:var(--bg); color:var(--white);}
  header{background:linear-gradient(180deg,var(--accent),var(--accent-weak)); padding:14px 12px; position:sticky; top:0; z-index:50; box-shadow:0 6px 18px rgba(0,0,0,0.35);}
  header .top {display:flex; align-items:center; gap:12px; max-width:1100px; margin:0 auto;}
  header .logo {width:36px; height:36px; border-radius:8px; background:rgba(255,255,255,0.12); display:inline-flex; align-items:center; justify-content:center;}
  header .logo img {width:100%; height:100%; object-fit:contain;}
  header h1{margin:0; font-size:18px; letter-spacing:0.6px; cursor:pointer;}
  header .controls {margin-left:auto; display:flex; gap:8px; align-items:center;}

  nav.main {
    max-width:1100px; margin:12px auto; padding:8px 10px; display:flex; gap:6px; align-items:center; justify-content:space-between;
  }

  .nav-left {display:flex; gap:8px; align-items:center;}
  .nav-btn {
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:6px; padding:8px 10px; min-width:64px; border-radius:10px; background:transparent; border:1px solid rgba(255,255,255,0.04);
    color:var(--muted); cursor:pointer; font-size:12px;
  }
  .nav-btn img{width:22px; height:22px; filter:invert(100%);}

  .nav-btn.active { box-shadow: 0 0 0 3px rgba(106,13,173,0.12); border-color:rgba(106,13,173,0.5); color:var(--white); }

  .container {max-width:1100px; margin:0 auto; padding:12px; box-sizing:border-box;}

  .page { display:none; }
  .page.active{ display:block; }

  .card { background:var(--card); border-radius:12px; padding:14px; box-shadow:0 6px 20px rgba(0,0,0,0.45); color:var(--white); }
  .row { display:flex; gap:8px; }
  .col { flex:1; }
  label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
  input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="url"], textarea, select {
    width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:var(--white);
    box-sizing:border-box; font-size:14px;
  }
  textarea { min-height:90px; resize:vertical; }

  .hint { font-size:12px; color:var(--muted); margin-top:6px; }

  .primary { background:linear-gradient(90deg,var(--accent),var--accent-weak); color:var(--white); border:none; padding:12px 14px; border-radius:10px; cursor:pointer; font-weight:600; width:100%; }
  .secondary { background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); padding:8px 12px; border-radius:8px; cursor:pointer; }

  .tabs { display:flex; gap:8px; margin-bottom:10px; align-items:center; }
  .tab { padding:8px 12px; border-radius:10px; cursor:pointer; background:transparent; border:1px solid rgba(255,255,255,0.03); color:var(--muted); display:inline-flex; gap:8px; align-items:center; }
  .tab.active { box-shadow: 0 0 0 3px rgba(106,13,173,0.08); border-color: rgba(106,13,173,0.35); color:var(--white); }

  .profiles { display:grid; grid-template-columns: repeat(2,1fr); gap:12px; }
  .profile { background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:10px; border-radius:10px; }
  .profile .imgwrap { border-radius:8px; overflow:hidden; height:160px; background:#111; display:flex; align-items:center; justify-content:center; }
  .profile img { width:100%; height:100%; object-fit:cover; display:block; }
  .profile h3 { margin:8px 0 4px; font-size:16px; }
  .profile p { margin:0; font-size:13px; color:var(--muted); }

  .icon-btn { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; padding:8px; border-radius:10px; background:transparent; border:none; cursor:pointer; color:var(--muted); font-size:12px; }
  .icon-btn img { width:28px; height:28px; filter:invert(100%); }

  @media (max-width:800px) {
    .profiles { grid-template-columns:1fr; }
    header .top { padding:0 8px; }
    .nav-btn { font-size:11px; min-width:56px; }
  }

  #loadingPopup {
    position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999;
    background:linear-gradient(180deg, rgba(5,5,10,0.5), rgba(5,5,10,0.6)); color:white;
  }
  .loader-card { background:rgba(255,255,255,0.03); padding:20px; border-radius:12px; display:flex; flex-direction:column; gap:12px; align-items:center; width:320px; max-width:90%; }
  .spinner {
    width:72px; height:72px; border-radius:999px; border:6px solid rgba(255,255,255,0.08); border-top-color:var(--accent); animation:spin 1s linear infinite;
  }
  @keyframes spin { to { transform:rotate(360deg) } }

  .small-muted { font-size:13px; color:rgba(255,255,255,0.7) }
  .error { color:#ff6b6b; font-weight:600; margin-top:6px }
  .success { color:#7af29a; font-weight:600; margin-top:6px }

  /* Initial loading screen */
  #initialLoading {
    position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; background:var(--bg); z-index:10000;
  }
  #initialLoading img { width:60%; max-width:400px; height:auto; margin-bottom:20px; }
  .progress-bar { width:200px; height:8px; background:rgba(255,255,255,0.1); border-radius:4px; overflow:hidden; }
  .progress { height:100%; background:linear-gradient(90deg, var(--accent), var(--accent-weak)); width:0; transition:width 3s ease-in-out; }
  .video-container { margin-top:12px; max-width:100%; }
  .video-container iframe { width:100%; max-width:560px; height:315px; border-radius:8px; }
</style>
</head>
<body>

<!-- Initial loading screen -->
<div id="initialLoading">
  <img src="login.png" alt="TapMeet Loading">
  <div class="progress-bar">
    <div class="progress" id="progressBar"></div>
  </div>
</div>

<header>
  <div class="top">
    <div class="logo"><img src="logo.png" alt="TapMeet Logo"></div>
    <h1 onclick="showPage('home')">TapMeet</h1>

    <div class="controls">
      <button class="icon-btn" id="installBtn" title="Install TapMeet" style="display:none">
        <img src="https://cdn-icons-png.flaticon.com/512/545/545665.png" alt="install">
        <div style="font-size:11px;color:rgba(255,255,255,0.85)">Install</div>
      </button>

      <button class="icon-btn" id="toggleModeBtn" title="Toggle mode">
        <img src="https://cdn-icons-png.flaticon.com/512/869/869869.png" alt="mode">
        <div style="font-size:11px;color:rgba(255,255,255,0.85)">Mode</div>
      </button>
    </div>
  </div>
</header>

<nav class="main">
  <div class="nav-left">
    <button class="nav-btn active" id="nav_home">
      <img src="https://cdn-icons-png.flaticon.com/512/1946/1946488.png" alt="home">
      <div style="font-size:11px">Home</div>
    </button>

    <button class="nav-btn" id="nav_signup">
      <img src="https://cdn-icons-png.flaticon.com/512/1828/1828961.png" alt="signup">
      <div style="font-size:11px">Signup</div>
    </button>

    <button class="nav-btn" id="nav_login">
      <img src="https://cdn-icons-png.flaticon.com/512/295/295128.png" alt="login">
      <div style="font-size:11px">Login</div>
    </button>

    <button class="nav-btn" id="nav_explore">
      <img src="https://cdn-icons-png.flaticon.com/512/1077/1077063.png" alt="explore">
      <div style="font-size:11px">Explore</div>
    </button>
  </div>

  <div style="display:flex; gap:8px; align-items:center;">
    <div style="font-size:12px; color:var(--muted)">TapMeet • <a href="mailto:s.tapmeet@gmail.com" style="color:var(--muted);text-decoration:none;">s.tapmeet@gmail.com</a></div>
  </div>
</nav>

<div class="container">

  <!-- HOME screen (landing + quick links) -->
  <section id="home" class="page active">
    <div class="card">
      <h2>Welcome to TapMeet</h2>
      <p class="small-muted">Find people near you. Please follow safety advice — never send money. For support, contact <a href="mailto:s.tapmeet@gmail.com">s.tapmeet@gmail.com</a>.</p>

      <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
        <button class="icon-btn" id="home_signup_btn">
          <img src="https://cdn-icons-png.flaticon.com/512/706/706164.png" alt="">
          <div>Join</div>
        </button>
        <button class="icon-btn" id="home_browse_btn">
          <img src="https://cdn-icons-png.flaticon.com/512/3523/3523063.png" alt="">
          <div>Browse</div>
        </button>
        <button class="icon-btn" id="home_account_btn">
          <img src="https://cdn-icons-png.flaticon.com/512/1828/1828490.png" alt="">
          <div>Account</div>
        </button>
      </div>
    </div>
  </section>

  <!-- SIGNUP -->
  <section id="signup" class="page">
    <div class="card">
      <h2>Create an account</h2>

      <div class="row" style="margin-top:8px">
        <div class="col">
          <label>Full name</label>
          <input id="su_name" type="text" placeholder="Jane Doe">
        </div>
        <div class="col">
          <label>Age</label>
          <input id="su_age" type="number" placeholder="e.g. 28">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Height (ft/in)</label>
          <input id="su_height" type="text" placeholder="e.g. 5'8 ft">
        </div>
        <div class="col">
          <label>Genotype (hint)</label>
          <input id="su_genotype" type="text" placeholder="AA, AS, SS, etc.">
        </div>
      </div>

      <label>Blood (stored as 'blood' in backend; shows as Genotype in UI)</label>
      <input id="su_blood" type="text" placeholder="A+, O-, etc.">

      <label>Location (city, details)</label>
      <input id="su_location" type="text" placeholder="Lagos, Nigeria">

      <label>Description</label>
      <textarea id="su_desc" placeholder="Tell people a little about yourself"></textarea>

      <label>Telegram ID (e.g. @dechris)</label>
      <input id="su_telegram" type="text" placeholder="@username">

      <label>WhatsApp or Email (public contact)</label>
      <input id="su_whatsapp" type="text" placeholder="+234... or email">

      <div style="display:flex; gap:8px; margin-top:8px;">
        <div style="flex:1">
          <label>Email (login)</label>
          <input id="su_email" type="email" placeholder="you@example.com">
        </div>
        <div style="flex:1">
          <label>Password</label>
          <input id="su_password" type="password" placeholder="choose a password">
        </div>
      </div>

      <label>Profile photo URL</label>
      <input id="su_photo_url" type="url" placeholder="https://example.com/image.jpg">
      <div class="hint">Need help getting an image URL? Watch the tutorial below.</div>

      <div style="display:flex; gap:8px; margin-top:12px;">
        <label style="display:flex; align-items:center; gap:8px;">
          <input id="agree_warn" type="checkbox"> I understand safety warnings.
        </label>
      </div>

      <div style="display:flex; gap:8px; margin-top:12px;">
        <button id="signupBtn" class="primary">Create account</button>
        <button id="clearSignupBtn" class="secondary">Clear</button>
      </div>

      <div id="signup_feedback" class="hint"></div>

      <div class="video-container">
        <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      </div>

      <div class="small-muted" style="margin-top:12px;">For assistance, contact <a href="mailto:s.tapmeet@gmail.com">s.tapmeet@gmail.com</a>.</div>
    </div>
  </section>

  <!-- LOGIN -->
  <section id="login" class="page">
    <div class="card">
      <h2>Login</h2>

      <label>Email</label>
      <input id="li_email" type="email">

      <label>Password</label>
      <input id="li_password" type="password">

      <div style="display:flex; gap:10px; align-items:center; margin-top:8px;">
        <label style="display:flex; align-items:center; gap:8px;">
          <input id="remember_me" type="checkbox"> Remember me
        </label>
        <div style="flex:1"></div>
        <button id="prefillBtn" class="secondary">Fill</button>
      </div>

      <div style="display:flex; gap:8px; margin-top:12px;">
        <button id="loginBtn" class="primary">Sign in</button>
      </div>

      <div id="login_feedback" class="hint"></div>
      <div class="small-muted" style="margin-top:12px;">Forgot password? Contact <a href="mailto:s.tapmeet@gmail.com">s.tapmeet@gmail.com</a>.</div>
    </div>
  </section>

  <!-- EXPLORE -->
  <section id="explore" class="page">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Explore</h2>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="tab active" id="tab_near">
            <img src="https://cdn-icons-png.flaticon.com/512/684/684908.png" style="width:18px;height:18px;filter:invert(100%)">
            Near me
          </button>
          <button class="tab" id="tab_all">
            <img src="https://cdn-icons-png.flaticon.com/512/709/709496.png" style="width:18px;height:18px;filter:invert(100%)">
            Show all
          </button>
        </div>
      </div>

      <div style="margin-top:8px;">
        <div class="small-muted">Tip: Tap a profile to view details. Contact info only available when logged in. For support, contact <a href="mailto:s.tapmeet@gmail.com">s.tapmeet@gmail.com</a>.</div>
      </div>

      <div id="profiles_container" style="margin-top:12px;">
        <div class="profiles" id="profiles"></div>
      </div>
    </div>
  </section>

</div>

<!-- Loading popup (only visible during actions) -->
<div id="loadingPopup" aria-hidden="true">
  <div class="loader-card">
    <div class="spinner" aria-hidden="true"></div>
    <div id="loadingText" class="small-muted">Processing...</div>
    <div id="loadingSub" class="small-muted" style="font-size:12px">Please wait — this should only take a few seconds.</div>
  </div>
</div>

<script>
/* ------------------------------
   CONFIG: Apps Script web app URL
   ------------------------------ */
const API_URL = "";

/* ------------------------------
   Small helpers
   ------------------------------ */
function showLoading(text) {
  document.getElementById('loadingText').innerText = text || 'Please wait...';
  document.getElementById('loadingPopup').style.display = 'flex';
}
function hideLoading() {
  document.getElementById('loadingPopup').style.display = 'none';
}
function showFeedback(id, msg, ok = true) {
  const el = document.getElementById(id);
  el.innerText = msg;
  el.classList.remove(ok ? 'error' : 'success');
  el.classList.add(ok ? 'success' : 'error');
}

/* ------------------------------
   Page navigation + nav active
   ------------------------------ */
function setNavActive(id) {
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
}
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const el = document.getElementById(name);
  if (el) el.classList.add('active');

  setNavActive(`nav_${name}`);
  if (name === 'explore') {
    loadProfiles();
  }
}

/* ------------------------------
   Theme toggle
   ------------------------------ */
function toggleMode() {
  document.body.classList.toggle('light');
}

/* ------------------------------
   Remember me: store credentials
   ------------------------------ */
function saveRemember(email, pass) {
  localStorage.setItem('tapmeet_remember', JSON.stringify({ email, pass }));
}
function loadRemember() {
  try {
    return JSON.parse(localStorage.getItem('tapmeet_remember'));
  } catch (e) {
    return null;
  }
}
function prefillFromRemember() {
  const r = loadRemember();
  if (r) {
    document.getElementById('li_email').value = r.email;
    document.getElementById('li_password').value = r.pass;
    showFeedback('login_feedback', 'Credentials filled (from Remember Me)', true);
  } else {
    showFeedback('login_feedback', 'No saved credentials.', false);
  }
}

/* ------------------------------
   Tabs: near / all
   ------------------------------ */
let currentTab = 'near';
function setTab(name) {
  currentTab = name;
  document.getElementById('tab_near').classList.toggle('active', name === 'near');
  document.getElementById('tab_all').classList.toggle('active', name === 'all');
  loadProfiles();
}

/* ------------------------------
   SIGNUP logic
   ------------------------------ */
async function signup() {
  const agree = document.getElementById('agree_warn').checked;
  if (!agree) {
    showFeedback('signup_feedback', 'Please agree to safety warning before signing up.', false);
    return;
  }

  const name = document.getElementById('su_name').value.trim();
  const age = document.getElementById('su_age').value.trim();
  const height = document.getElementById('su_height').value.trim();
  const blood = document.getElementById('su_blood').value.trim();
  const genotype = document.getElementById('su_genotype').value.trim();
  const location = document.getElementById('su_location').value.trim();
  const desc = document.getElementById('su_desc').value.trim();
  const telegram = document.getElementById('su_telegram').value.trim();
  const whatsapp = document.getElementById('su_whatsapp').value.trim();
  const email = document.getElementById('su_email').value.trim();
  const password = document.getElementById('su_password').value;
  const photoURL = document.getElementById('su_photo_url').value.trim();

  if (!name || !email || !password) {
    showFeedback('signup_feedback', 'Please provide name, email, and password.', false);
    return;
  }

  showLoading('🚀 Creating account...');

  const payload = {
    action: "signup",
    name, age, height, blood, genotype, location, desc, telegram, whatsapp, email, password, photo: photoURL || ""
  };

  try {
    const resp = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify(payload),
      headers: { 'Content-Type': 'application/json' }
    });

    const json = await resp.json();
    hideLoading();
    if (json && json.success) {
      showFeedback('signup_feedback', '✅ Signup successful. Please proceed to login.', true);
      document.getElementById('li_email').value = email;
      showPage('login');
    } else {
      const msg = json && json.message ? json.message : JSON.stringify(json);
      showFeedback('signup_feedback', '❌ Signup failed: ' + msg, false);
    }
  } catch (err) {
    hideLoading();
    showFeedback('signup_feedback', '❌ Network error: ' + err.message, false);
  }
}

/* ------------------------------
   LOGIN logic (with Remember Me)
   ------------------------------ */
async function login() {
  const email = document.getElementById('li_email').value.trim();
  const password = document.getElementById('li_password').value;
  const remember = document.getElementById('remember_me').checked;

  if (!email || !password) {
    showFeedback('login_feedback', 'Please enter email & password', false);
    return;
  }

  showLoading('🔐 Signing in...');

  const payload = { action: 'login', email, password };

  try {
    const resp = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify(payload),
      headers: { 'Content-Type': 'application/json' }
    });
    const json = await resp.json();
    hideLoading();
    if (json && json.success) {
      const user = json.user;
      localStorage.setItem('tapmeet_user', JSON.stringify(user));
      if (remember) saveRemember(email, password);
      else localStorage.removeItem('tapmeet_remember');

      showFeedback('login_feedback', '✅ Welcome, ' + (user.name || user.email), true);
      showPage('explore');
    } else {
      const msg = json && json.message ? json.message : JSON.stringify(json);
      showFeedback('login_feedback', '❌ Login failed: ' + msg, false);
    }
  } catch (err) {
    hideLoading();
    showFeedback('login_feedback', '❌ Network error: ' + err.message, false);
  }
}

/* ------------------------------
   LOAD PROFILES
   ------------------------------ */
async function loadProfiles() {
  showLoading('🔎 Loading profiles...');
  try {
    const resp = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'getProfiles' }),
      headers: { 'Content-Type': 'application/json' }
    });
    const json = await resp.json();
    hideLoading();
    if (!json || !json.success) {
      document.getElementById('profiles').innerHTML = '<div class="small-muted">No profiles found.</div>';
      return;
    }

    let users = json.users || [];
    if (currentTab === 'near' && navigator.geolocation) {
      try {
        const pos = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
        });
        const myLat = pos.coords.latitude;
        const myLon = pos.coords.longitude;
        users = users.map(u => {
          let distance = null;
          if (u.location && typeof u.location === 'string' && u.location.match(/^-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?$/)) {
            const parts = u.location.split(',').map(s => parseFloat(s.trim()));
            const lat = parts[0], lon = parts[1];
            distance = haversineDistance(myLat, myLon, lat, lon);
          }
          return { ...u, distance };
        }).filter(u => u.distance !== null).sort((a, b) => a.distance - b.distance);
        if (users.length === 0) {
          users = json.users;
        }
      } catch (e) {
        users = json.users;
      }
    }

    if (currentTab === 'all') users = json.users;
    renderProfiles(users);
  } catch (err) {
    hideLoading();
    document.getElementById('profiles').innerHTML = '<div class="error">Error loading profiles: ' + err.message + '</div>';
  }
}

/* Haversine distance in km */
function haversineDistance(lat1, lon1, lat2, lon2) {
  const toRad = v => v * Math.PI / 180;
  const R = 6371; // km
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

/* Render profiles grid */
function renderProfiles(users) {
  const container = document.getElementById('profiles');
  container.innerHTML = '';
  if (!users || users.length === 0) {
    container.innerHTML = '<div class="small-muted">No users found.</div>';
    return;
  }

  const loggedIn = !!localStorage.getItem('tapmeet_user');

  users.forEach(u => {
    const el = document.createElement('div');
    el.className = 'profile';
    const imgSrc = u.photo || '';
    const imgHtml = imgSrc ? `<div class="imgwrap"><img src="${imgSrc}" alt="${u.name}"></div>` : `<div class="imgwrap"><div style="color:var(--muted);padding:12px">No photo</div></div>`;
    const genotype = u.genotype || u.blood || 'N/A';
    el.innerHTML = `
      ${imgHtml}
      <h3>${u.name || 'Unnamed'} ${u.age ? ', ' + u.age : ''}</h3>
      <p>${loggedIn ? `Genotype: ${genotype} • Height: ${u.height || 'N/A'}` : ''}</p>
      <p class="small-muted">${u.location || ''}${u.distance ? ' • ' + u.distance.toFixed(1) + ' km' : ''}</p>
      ${loggedIn ? `<p>${u.desc || ''}</p>
        <p>Telegram: ${u.telegram || '—'}</p>
        <p>Contact: ${u.whatsapp || '—'}</p>`
        : `<p class="small-muted">Login to see more details. Photos blurred for privacy.</p>`
      }
    `;
    if (!loggedIn) {
      const imgEl = el.querySelector('img');
      if (imgEl) imgEl.style.filter = 'blur(6px)';
    }
    container.appendChild(el);
  });
}

/* ------------------------------
   Utility: clear signup
   ------------------------------ */
function clearSignup() {
  ['su_name', 'su_age', 'su_height', 'su_blood', 'su_genotype', 'su_location', 'su_desc', 'su_telegram', 'su_whatsapp', 'su_email', 'su_password', 'su_photo_url'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  document.getElementById('agree_warn').checked = false;
  showFeedback('signup_feedback', 'Cleared.', true);
}

/* ------------------------------
   PWA install prompt handling
   ------------------------------ */
let deferredPrompt;
const installBtn = document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = 'inline-flex';
});
installBtn.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const choice = await deferredPrompt.userChoice;
  if (choice.outcome === 'accepted') {
    installBtn.style.display = 'none';
  }
  deferredPrompt = null;
});

/* ------------------------------
   Initial loading screen
   ------------------------------ */
function hideInitialLoading() {
  const initialLoading = document.getElementById('initialLoading');
  initialLoading.style.opacity = '0';
  setTimeout(() => {
    initialLoading.style.display = 'none';
  }, 500); // Match CSS transition duration
}

/* ------------------------------
   Event Listeners
   ------------------------------ */
document.addEventListener('DOMContentLoaded', () => {
  // Start progress bar animation
  const progressBar = document.getElementById('progressBar');
  setTimeout(() => {
    progressBar.style.width = '100%';
  }, 50);
  setTimeout(hideInitialLoading, 3000);

  hideLoading();
  const rem = loadRemember();
  if (rem) {
    document.getElementById('li_email').value = rem.email;
    document.getElementById('li_password').value = rem.pass;
    document.getElementById('remember_me').checked = true;
  }
  setNavActive('nav_home');

  // Navigation buttons
  document.getElementById('nav_home').addEventListener('click', () => showPage('home'));
  document.getElementById('nav_signup').addEventListener('click', () => showPage('signup'));
  document.getElementById('nav_login').addEventListener('click', () => showPage('login'));
  document.getElementById('nav_explore').addEventListener('click', () => showPage('explore'));

  // Home page buttons
  document.getElementById('home_signup_btn').addEventListener('click', () => showPage('signup'));
  document.getElementById('home_browse_btn').addEventListener('click', () => showPage('explore'));
  document.getElementById('home_account_btn').addEventListener('click', () => showPage('login'));

  // Signup and login buttons
  document.getElementById('signupBtn').addEventListener('click', signup);
  document.getElementById('clearSignupBtn').addEventListener('click', clearSignup);
  document.getElementById('loginBtn').addEventListener('click', login);
  document.getElementById('prefillBtn').addEventListener('click', prefillFromRemember);

  // Tab buttons
  document.getElementById('tab_near').addEventListener('click', () => setTab('near'));
  document.getElementById('tab_all').addEventListener('click', () => setTab('all'));

  // Theme toggle
  document.getElementById('toggleModeBtn').addEventListener('click', toggleMode);
});
</script>

</body>
</html>
