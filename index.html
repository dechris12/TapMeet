<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ğŸ’œ TapMeet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- âœ… Responsive -->
  <meta name="theme-color" content="#6a0dad">
  <link rel="manifest" href="manifest.json">
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f7f0ff; color:#222; }
    header { background:#6a0dad; color:white; text-align:center; padding:15px; position:sticky; top:0; }
    nav { background:#8a2be2; display:flex; justify-content:center; flex-wrap:wrap; gap:10px; padding:10px; }
    nav button { background:white; color:#6a0dad; border:none; padding:10px 15px; border-radius:20px; cursor:pointer; font-size:14px; display: flex; flex-direction: column; align-items: center; }
    nav button:hover { background:#eee; }
    .icon { font-size: 20px; }
    .caption { font-size: 10px; }
    .section { display:none; padding:20px; max-width:600px; margin:auto; }
    .active { display:block; }
    input, textarea { width:100%; padding:10px; margin:6px 0; border-radius:5px; border:1px solid #ccc; font-size:14px; }
    button.main-btn { background:#6a0dad; color:white; border:none; padding:12px; border-radius:10px; cursor:pointer; font-size:15px; width:100%; display: flex; align-items: center; justify-content: center; gap: 8px; }
    button.main-btn:hover { background:#500a96; }
    .profile-card { background:white; border-radius:10px; padding:15px; margin:10px 0; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .profile-card img { width:100%; max-height:200px; object-fit:cover; border-radius:10px; }
    /* Dark mode */
    .dark { background:#121212; color:white; }
    .dark header { background:#3c0a64; }
    .dark nav { background:#500a96; }
    .dark input, .dark textarea { background:#1e1e1e; color:white; border:1px solid #555; }
    .dark .profile-card { background:#1e1e1e; color:white; }
    .toggle { position:absolute; right:20px; top:20px; cursor:pointer; font-size:20px; }
    /* Loading Popup */
    #loadingPopup {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.8); color:white; display:flex;
      align-items:center; justify-content:center; flex-direction:column;
      z-index:2000; text-align:center;
    }
    .spinner {
      border:6px solid #444; border-top:6px solid #6a0dad;
      border-radius:50%; width:60px; height:60px;
      animation: spin 1s linear infinite; margin-bottom:20px;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    /* Tabs in Explore */
    .tabs { display: flex; justify-content: center; gap: 10px; padding: 10px; }
    .tab { background: white; color: #6a0dad; border: none; padding: 10px 15px; border-radius: 20px; cursor: pointer; font-size: 14px; display: flex; flex-direction: column; align-items: center; }
    .tab:hover { background: #eee; }
    .tab.active { border: 2px solid #d8b4fe; } /* Light purple stroke */
    /* Mobile friendly */
    @media (max-width:600px) {
      nav button { font-size:12px; padding:8px; }
      input, textarea { font-size:13px; }
      button.main-btn { font-size:14px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ’œ TapMeet</h1>
    <span class="toggle" onclick="toggleMode()">ğŸŒ“</span>
  </header>

  <nav>
    <button onclick="showSection('signup')">
      <span class="icon">ğŸ“</span>
      <span class="caption">Signup</span>
    </button>
    <button onclick="showSection('login')">
      <span class="icon">ğŸ”‘</span>
      <span class="caption">Login</span>
    </button>
    <button onclick="showSection('explore')">
      <span class="icon">ğŸ”</span>
      <span class="caption">Explore</span>
    </button>
  </nav>

  <!-- Signup -->
  <div id="signup" class="section active">
    <h2>Create Account</h2>
    <input id="su_name" placeholder="Name" required>
    <input id="su_age" placeholder="Age" required>
    <input id="su_height" placeholder="Height" required>
    <input id="su_blood" placeholder="Blood Group" required>
    <input id="su_genotype" placeholder="Genotype" required>
    <input id="su_location" placeholder="Location">
    <textarea id="su_desc" placeholder="Description"></textarea>
    <input id="su_telegram" placeholder="Telegram">
    <input id="su_whatsapp" placeholder="WhatsApp">
    <input id="su_email" type="email" placeholder="Email" required>
    <input id="su_password" type="password" placeholder="Password" required>
    <input id="su_photo" placeholder="Photo URL">
    <button class="main-btn" onclick="signup()"><span class="icon">ğŸ“</span>Sign Up</button>
    <p id="signup_msg"></p>
  </div>

  <!-- Login -->
  <div id="login" class="section">
    <h2>Login</h2>
    <input id="li_email" placeholder="Email">
    <input id="li_password" type="password" placeholder="Password">
    <label><input type="checkbox" id="remember"> Remember me</label>
    <button class="main-btn" onclick="login()"><span class="icon">ğŸ”‘</span>Login</button>
    <p id="login_msg"></p>
  </div>

  <!-- Explore -->
  <div id="explore" class="section">
    <h2>Explore Profiles</h2>
    <div class="tabs">
      <button id="showall" class="tab active" onclick="showTab('all')">
        <span class="icon">ğŸŒ</span>
        <span class="caption">Show All</span>
      </button>
      <button id="nearme" class="tab" onclick="showTab('near')">
        <span class="icon">ğŸ“</span>
        <span class="caption">Near Me</span>
      </button>
    </div>
    <div id="profiles"></div>
  </div>

  <!-- Futuristic Loading Popup -->
  <div id="loadingPopup">
    <div class="spinner"></div>
    <h3 id="loadingText">Please wait...</h3>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzA9ReKAtIBXOU4ySInm3a06-hmTBZ11dqBqjIfPEYKVrFxTo2X0Ylyi9vD9XMzrzQ/exec";

    // Persist dark mode
    if (localStorage.getItem('dark') === 'true') {
      document.body.classList.add('dark');
    }

    // Prefill email if remembered
    const rememberedEmail = localStorage.getItem('email');
    if (rememberedEmail) {
      document.getElementById('li_email').value = rememberedEmail;
    }

    // PWA Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('Service Worker registered'))
          .catch(err => console.log('Service Worker error:', err));
      });
    }

    function toggleMode() {
      document.body.classList.toggle("dark");
      localStorage.setItem('dark', document.body.classList.contains('dark'));
    }

    function showSection(id) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      if (id === 'explore') {
        showTab('all');
      }
    }

    function showTab(mode) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(mode === 'all' ? 'showall' : 'nearme').classList.add('active');
      loadProfiles(mode);
    }

    function showLoading(text) {
      document.getElementById("loadingText").innerText = text;
      document.getElementById("loadingPopup").style.display = "flex";
    }
    function hideLoading() {
      document.getElementById("loadingPopup").style.display = "none";
    }

    function getCurrentPosition() {
      return new Promise((resolve, reject) => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(resolve, reject);
        } else {
          reject(new Error('Geolocation not supported'));
        }
      });
    }

    async function getCityFromCoords(lat, lon) {
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10`);
        const data = await res.json();
        return data.address.city || data.address.town || data.address.village || '';
      } catch (err) {
        return '';
      }
    }

    async function signup() {
      showLoading("ğŸš€ Creating your TapMeet account...");
      const data = {
        action: "signup",
        name: document.getElementById("su_name").value,
        age: document.getElementById("su_age").value,
        height: document.getElementById("su_height").value,
        blood: document.getElementById("su_blood").value,
        genotype: document.getElementById("su_genotype").value,
        location: document.getElementById("su_location").value,
        description: document.getElementById("su_desc").value,
        telegram: document.getElementById("su_telegram").value,
        whatsapp: document.getElementById("su_whatsapp").value,
        email: document.getElementById("su_email").value,
        password: document.getElementById("su_password").value,
        photo: document.getElementById("su_photo").value
      };
      try {
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(data) });
        const result = await res.json();
        hideLoading();
        document.getElementById("signup_msg").innerText = result.message || JSON.stringify(result);
      } catch (err) {
        hideLoading();
        document.getElementById("signup_msg").innerText = "âŒ Error: " + err.message;
      }
    }

    async function login() {
      showLoading("ğŸ”‘ Logging into TapMeet...");
      const email = document.getElementById("li_email").value;
      const remember = document.getElementById("remember").checked;
      if (remember) {
        localStorage.setItem('email', email);
      } else {
        localStorage.removeItem('email');
      }
      const data = {
        action: "login",
        email: email,
        password: document.getElementById("li_password").value
      };
      try {
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(data) });
        const result = await res.json();
        hideLoading();
        if (result.success) {
          document.getElementById("login_msg").innerText = "âœ… Welcome " + result.user.name;
          showSection("explore");
        } else {
          document.getElementById("login_msg").innerText = "âŒ " + result.message;
        }
      } catch (err) {
        hideLoading();
        document.getElementById("login_msg").innerText = "âŒ Error: " + err.message;
      }
    }

    async function loadProfiles(mode = 'all') {
      showLoading("ğŸ”„ Loading profiles...");
      const container = document.getElementById("profiles");
      container.innerHTML = "";
      try {
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getProfiles" }) });
        const result = await res.json();
        let users = result.success ? result.users : [];
        if (mode === 'near') {
          try {
            showLoading("ğŸ“ Getting your location...");
            const position = await getCurrentPosition();
            const city = await getCityFromCoords(position.coords.latitude, position.coords.longitude);
            if (city) {
              users = users.filter(user => user.location && user.location.toLowerCase().includes(city.toLowerCase()));
            } else {
              container.innerHTML = "<p>Unable to detect location.</p>";
              hideLoading();
              return;
            }
          } catch (err) {
            container.innerHTML = "<p>Location access denied or error: " + err.message + "</p>";
            hideLoading();
            return;
          }
        }
        if (users.length) {
          users.forEach(user => {
            const card = document.createElement("div");
            card.className = "profile-card";
            card.innerHTML = `
              <img src="${user.photo || ''}" alt="photo">
              <h3>${user.name}, ${user.age}</h3>
              <p>${user.description || ''}</p>
              <p>ğŸ“ ${user.location || ''}</p>
              <p>ğŸ’¬ Telegram: ${user.telegram || ''}</p>
              <p>ğŸ“± WhatsApp: ${user.whatsapp || ''}</p>
              <p>ğŸ©¸ Blood: ${user.blood || ''}, Genotype: ${user.genotype || ''}</p>
            `;
            container.appendChild(card);
          });
        } else {
          container.innerHTML = "<p>No profiles found.</p>";
        }
        hideLoading();
      } catch (err) {
        hideLoading();
        container.innerHTML = "âŒ Error: " + err.message;
      }
    }
  </script>
</body>
  </html>
